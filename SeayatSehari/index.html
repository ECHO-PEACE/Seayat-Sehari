<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SEAYAT SEHARI</title>
  <meta name="theme-color" content="#4CAF50" />
  <link rel="icon" href="logo.png" type="image/png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--green:#4CAF50;--dark:#09310a;--bg:#f4fff4}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--dark);margin:0}
    header{background:linear-gradient(180deg,var(--green),#2e7d32);color:#fff;padding:18px 16px;text-align:center;border-bottom-left-radius:18px;border-bottom-right-radius:18px}
    header img{width:88px;height:88px;border-radius:16px;display:block;margin:6px auto}
    h1{margin:6px 0;font-size:2rem;letter-spacing:2px}
    .container{max-width:980px;margin:18px auto;padding:12px}
    .card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 8px 30px rgba(3,10,8,0.06)}
    .emotions{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:10px}
    .emotion-tile{background:linear-gradient(180deg,#fff,#f7fff7);border-radius:12px;padding:10px;text-align:center;cursor:pointer;box-shadow:0 4px 14px rgba(2,50,12,0.05)}
    .emotion-emoji{font-size:2.4rem;display:block}
    .emotion-label{margin-top:8px;font-weight:600;color:var(--dark)}
    .selected{outline:4px solid rgba(76,175,80,0.18)}
    #verseBox{margin-top:14px;padding:14px;border-radius:10px;background:#fff;min-height:90px}
    #verse{font-style:italic;color:#0b3d0b}
    .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:12px}
    button{border-radius:10px;padding:8px 12px;border:none;cursor:pointer}
    .primary{background:var(--green);color:#042803}
    .ghost{background:transparent;border:1px solid rgba(0,0,0,0.08)}
    .small{font-size:13px;color:#356b3b}
    #note{width:100%;min-height:90px;padding:8px;border-radius:8px;border:1px solid #e6f1ea}
    #chartWrap{margin-top:16px;background:#fff;padding:12px;border-radius:10px}
    footer{margin:20px 0;text-align:center;color:#376b3a;font-size:13px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center}
    .hidden{display:none}
    @media(max-width:720px){ .emotions{grid-template-columns:repeat(2,1fr)} h1{font-size:1.6rem} }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo SEAYAT SEHARI" />
    <h1>SEAYAT SEHARI</h1>
    <div style="opacity:.95">Ayat harian sesuai perasaan — renungan & kesadaran digital</div>
  </header>

  <main class="container">
    <section class="card">
      <h2 style="text-align:center">Bagaimana perasaanmu hari ini?</h2>

      <div class="emotions" id="emotionGrid">
        <div class="emotion-tile" data-emotion="senang"><span class="emotion-emoji">😊</span><span class="emotion-label">Senang</span></div>
        <div class="emotion-tile" data-emotion="sedih"><span class="emotion-emoji">😢</span><span class="emotion-label">Sedih</span></div>
        <div class="emotion-tile" data-emotion="marah"><span class="emotion-emoji">😡</span><span class="emotion-label">Marah</span></div>
        <div class="emotion-tile" data-emotion="kecewa"><span class="emotion-emoji">😞</span><span class="emotion-label">Kecewa</span></div>
        <div class="emotion-tile" data-emotion="cemas"><span class="emotion-emoji">😰</span><span class="emotion-label">Cemas</span></div>
        <div class="emotion-tile" data-emotion="takut"><span class="emotion-emoji">😨</span><span class="emotion-label">Takut</span></div>
      </div>

      <div id="verseBox">
        <div id="emotionTitle" style="font-weight:700;margin-bottom:6px">Pilih emosi untuk melihat ayat</div>
        <div id="verse">Ayat akan muncul di sini...</div>
      </div>

      <div class="controls" style="margin-top:12px">
        <button class="primary" id="checkInBtn">Check-in Hari Ini</button>
        <button class="ghost" id="shareBtn">Bagikan Ayat</button>
        <button class="ghost" id="historyBtn">Riwayat</button>
        <button class="ghost" id="notesBtn">Catatan</button>
        <button class="ghost" id="statsBtn">Statistik</button>
      </div>

      <div style="margin-top:12px;text-align:center" class="row">
        <div class="small">Reminder harian:</div>
        <input type="time" id="dailyTime" value="07:00" />
        <button class="ghost" id="setDailyBtn">Set & Aktifkan</button>
        <div id="notifStatus" class="small"></div>
      </div>

      <div style="margin-top:12px;text-align:center" class="row">
        <div class="small">Pengingat penggunaan: akan muncul setelah <strong>60 menit</strong> di halaman.</div>
        <div id="usageStatus" class="small"></div>
      </div>

      <div style="margin-top:14px">
        <div id="streak">🔥 Streak: <span id="streakCount">0</span> hari</div>
      </div>
    </section>

    <!-- Notes modal-like area -->
    <section class="card" id="notesCard" style="margin-top:14px">
      <h3>Catatan Renungan</h3>
      <textarea id="note" placeholder="Tulis renunganmu..."></textarea>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
        <button class="primary" id="saveNote">Simpan Catatan</button>
        <button class="ghost" id="viewNote">Lihat Catatan Hari Ini</button>
      </div>
    </section>

    <section class="card" id="historyCard" style="margin-top:14px;display:none">
      <h3>Riwayat Terbaru</h3>
      <div id="historyList" style="text-align:left;max-height:240px;overflow:auto;padding:8px"></div>
    </section>

    <section class="card" id="statsCard" style="margin-top:14px;display:none">
      <h3>Statistik Emosi</h3>
      <div id="chartWrap"><canvas id="chartCanvas" height="120"></canvas></div>
    </section>

  </main>

  <footer>
    SEAYAT SEHARI • Ayat dari Terjemahan Lama (TL) — Offline-ready.
  </footer>

  <!-- DATA: 20 ayat per emosi (Terjemahan Lama / domain publik) -->
  <script>
const ALL_VERSES = {
  senang: [
    "Mazmur 118:24 — Inilah hari yang dijadikan TUHAN, marilah kita bersorak-sorai dan bersukacita karenanya.",
    "Filipi 4:4 — Bersukacitalah senantiasa dalam Tuhan! Sekali lagi kukatakan: Bersukacitalah!",
    "Mazmur 16:11 — Engkau memberitahukan kepadaku jalan kehidupan; di hadapan-Mu ada sukacita berlimpah.",
    "Nehemia 8:10 — Kesukacitaan pada TUHAN itulah kekuatanmu.",
    "Amsal 15:13 — Hati yang gembira membuat muka berseri-seri, tetapi kepedihan hati mematahkan semangat.",
    "Mazmur 30:12 — Kau ubah ratapku menjadi tari-tarian; kain kabungku kau lepaskan.",
    "Yesaya 61:10 — Aku bersukaria di dalam TUHAN, jiwaku bersorak di dalam Allahku.",
    "Mazmur 100:2 — Beribadahlah kepada TUHAN dengan sukacita; datanglah ke hadapan-Nya dengan sorak-sorai.",
    "Mazmur 37:4 — Bergembiralah karena TUHAN, maka Ia akan memberikan kepadamu apa yang diinginkan hatimu.",
    "Yohanes 15:11 — Semua itu Kukatakan kepadamu supaya sukacitamu menjadi penuh.",
    "Mazmur 126:3 — TUHAN telah melakukan perkara-perkara besar kepada kita; kita bersukacita.",
    "Roma 15:13 — Kiranya Allah sumber pengharapan memenuhi kamu dengan segala sukacita dan damai sejahtera.",
    "Mazmur 92:4 — Pada waktu pagi engkau mengisinya dengan rahmat-Mu; bergembira kita sambut hari ini.",
    "Mazmur 71:23 — Hatiku bersorak-sorai karena Engkau; lidahku akan menyanyikan puji-pujian.",
    "Yesaya 12:3 — Dengan sukacita kamu akan meminum air keselamatan.",
    "Mazmur 145:7 — Mereka menceritakan perbuatan-perbuatan-Mu, dan menyatakan kebesaran-Mu.",
    "Zabur 89:15 — Berbahagialah umat yang mengenal sorak-sorai.",
    "1 Petrus 1:8 — Kamu bergembira dengan sukacita yang tak terkatakan dan penuh kemuliaan.",
    "Mazmur 9:2 — Aku hendak bersyukur kepada TUHAN dengan segenap hatiku; aku hendak menceritakan segala keajaiban-Nya.",
    "Nehemia 8:10 — (diulang untuk penegasan: sukacita adalah kekuatan)."
  ],
  sedih: [
    "Mazmur 34:19 — TUHAN itu dekat kepada orang yang patah hati, dan Ia menyelamatkan orang-orang yang remuk jiwanya.",
    "Matius 5:4 — Berbahagialah orang yang berdukacita, karena mereka akan dihibur.",
    "Mazmur 147:3 — Ia menyembuhkan orang-orang yang patah hati dan membalut luka-luka mereka.",
    "Wahyu 21:4 — Dan Ia akan menghapus segala air mata dari mata mereka; dan maut tidak akan ada lagi.",
    "Mazmur 42:6 — Mengapa engkau tertekan, hai jiwaku? Berharaplah kepada Allah.",
    "Mazmur 30:6 — Sesaat saja murka-Nya, tetapi seumur hidup kemurahan-Nya.",
    "Yeremia 31:13 — Aku akan mengubah perkabungan mereka menjadi kegirangan.",
    "Yesaya 41:10 — Jangan takut, sebab Aku menyertai engkau; jangan bimbang, sebab Aku ini Allahmu.",
    "Mazmur 56:9 — Engkau telah menghitung tiap tangisanku; Engkau telah menyimpan tiap keluhanku.",
    "Mazmur 73:26 — Sekalipun dagingku dan hatiku habis lenyap, Allah tetap kekuatanku.",
    "Mazmur 9:10 — TUHAN tempat perlindungan bagi orang yang tertindas.",
    "Mazmur 27:10 — Sekalipun ayahku dan ibuku meninggalkan aku, namun TUHAN menyambut aku.",
    "Mazmur 55:23 — Serahkanlah kuatirmu kepada TUHAN, maka Ia memelihara engkau.",
    "Mazmur 126:5 — Orang yang menabur dengan mencucurkan air mata akan menuai dengan bersorak-sorai.",
    "Roma 8:18 — Penderitaan zaman sekarang tidak sebanding dengan kemuliaan yang akan dinyatakan.",
    "Mazmur 23:4 — Sekalipun aku berjalan dalam lembah kekelaman, aku tidak takut bahaya; sebab Engkau besertaku.",
    "2 Korintus 1:3-4 — Allah segala penghiburan yang menghibur kami dalam segala kesesakan.",
    "Mazmur 6:9 — TUHAN telah mendengar tangisku.",
    "Mazmur 119:50 — Penghiburan di dalam sengsara bahwa firman-Mu memberi hidup.",
    "Yesaya 43:2 — Apabila engkau menyeberang melalui air, Aku menyertai engkau."
  ],
  marah: [
    "Efesus 4:26 — Apabila kamu menjadi marah, janganlah kamu berbuat dosa; janganlah matahari terbenam ketika kamu masih marah.",
    "Yakobus 1:19-20 — Hendaklah setiap orang cepat untuk mendengar, lambat untuk berkata-kata, dan lambat untuk marah.",
    "Amsal 15:1 — Jawaban yang lemah lembut meredakan kegeraman.",
    "Amsal 29:11 — Orang bebal melampiaskan seluruh amarahnya, tetapi orang bijak menahan diri.",
    "Kolose 3:8 — Buanglah segala kemarahan, amarah, dan fitnah.",
    "Amsal 16:32 — Orang yang sabar melebihi pahlawan.",
    "Mazmur 37:8 — Berhentilah marah dan tinggalkan panas hati.",
    "Roma 12:19 — Janganlah menuntut pembalasan sendiri; biarkan murka Allah.",
    "Amsal 19:11 — Hati yang penuh pengertian menahan amarah.",
    "Yakobus 1:20 — Karena amarah manusia tidak mengerjakan kebenaran di hadapan Allah.",
    "Mazmur 4:4 — Berdiam dirilah dan jangan berbuat dosa; pikirkan dihatimu untuk istirahat.",
    "Pengkhotbah 7:9 — Jangan lekas marah dalam hati.",
    "Amsal 14:29 — Orang yang lambat murka besar pengertian.",
    "Roma 14:19 — Usahakanlah apa yang mendatangkan damai sejahtera.",
    "1 Petrus 3:9 — Jangan membalas kejahatan dengan kejahatan.",
    "Amsal 25:28 — Orang yang tidak dapat menahan diri seperti kota roboh.",
    "Efesus 4:31-32 — Buanglah segala kepahitan dan amarah; hendaklah kamu ramah.",
    "Mazmur 103:8 — TUHAN pengasih dan penyayang, panjang sabar dan berlimpah kasih setia.",
    "Amsal 15:18 — Orang pemarah menimbulkan perdebatan, orang sabar meredakan pertikaian.",
    "2 Timotius 2:24 — Hamba Tuhan harus lembut terhadap semua orang, cakap mengajar."
  ],
  kecewa: [
    "Yeremia 29:11 — Sebab Aku ini mengetahui rancangan-rancangan yang ada pada-Ku mengenai kamu.",
    "Roma 8:28 — Allah turut bekerja dalam segala sesuatu untuk mendatangkan kebaikan.",
    "Mazmur 42:11 — Mengapa engkau tertekan, hai jiwaku? Harapkanlah kepada Allah.",
    "Yesaya 40:31 — Orang yang menanti-nantikan TUHAN mendapat kekuatan baru.",
    "Amsal 3:5-6 — Percayalah kepada TUHAN dengan segenap hatimu.",
    "Mazmur 73:26 — Hatiku dan dagingku mungkin lemah, tetapi Allah adalah kekuatan hatiku.",
    "Filipi 1:6 — Dia yang memulai pekerjaan baik akan meneruskannya hingga akhir.",
    "Mazmur 9:10 — Mereka yang mengenal nama-Mu percaya kepada-Mu.",
    "Yesaya 43:2 — Ketika engkau menyeberang perairan, Aku menyertai engkau.",
    "Yeremia 31:25 — Aku akan memberi kelegaan kepada yang letih.",
    "Mazmur 119:50 — Firman-Mu memberi hidup di dalam kesengsaraanku.",
    "Mazmur 30:5 — Tangisan mungkin berlangsung semalaman, tetapi sukacita datang pada pagi hari.",
    "Yohanes 14:27 — Damai Kutinggalkan bagimu; damai-Ku Kuberikan kepadamu.",
    "2 Korintus 4:16-18 — Sengsara sekarang hanyalah sementara dibanding kemuliaan nanti.",
    "Mazmur 16:8 — Aku selalu menaruh TUHAN di hadapanku; aku tidak goyah.",
    "Yesaya 26:3 — Engkau menjaga orang yang hatinya teguh dengan damai sejahtera.",
    "Mazmur 55:22 — Serahkanlah kuatirmu kepada TUHAN; Ia memelihara engkau.",
    "Amsal 16:9 — Hati manusia merencanakan jalannya, tetapi TUHAN menentukan arah langkahnya.",
    "Mazmur 37:23 — Langkah orang saleh ditetapkan TUHAN.",
    "Yosua 1:9 — Kuatkan dan teguhkanlah hatimu; jangan takut dan jangan tawar hati."
  ],
  cemas: [
    "Filipi 4:6 — Janganlah hendaknya kamu kuatir tentang apa pun juga.",
    "1 Petrus 5:7 — Serahkanlah segala kekuatiranmu kepada-Nya, karena Ia memelihara kamu.",
    "Matius 6:34 — Janganlah kamu kuatir akan hari esok.",
    "Mazmur 94:19 — Dalam banyaknya pikiran di dalam hatiku, penghiburan-Mulah yang menyenangkan jiwaku.",
    "Mazmur 55:22 — Serahkanlah kuatirmu kepada TUHAN, maka Ia memelihara engkau.",
    "Yesaya 26:3 — Engkau memelihara orang yang hatinya teguh dengan damai sejahtera.",
    "Mazmur 23:1-4 — TUHANlah gembalaku; aku tidak akan kekurangan.",
    "Matius 11:28 — Marilah kepada-Ku, semua yang letih lesu, Aku memberi kelegaan.",
    "Yesaya 41:10 — Jangan takut, sebab Aku menyertai engkau.",
    "Mazmur 46:1 — Allah itu tempat perlindungan dan kekuatan, pertolongan dalam kesesakan selalu tersedia.",
    "Yohanes 14:1 — Janganlah gelisah hatimu; percayalah kepada Allah.",
    "Mazmur 34:4 — Aku mencari TUHAN, lalu Ia menjawab aku dan melepaskan aku dari semua ketakutanku.",
    "Yeremia 17:7-8 — Berbahagialah orang yang percaya kepada TUHAN; ia seperti pohon di tepi air.",
    "Mazmur 62:8 — Taruhlah harapanmu kepada Allah senantiasa.",
    "Yesaya 12:2 — Sesungguhnya Allah adalah keselamatanku; aku percaya dan tidak takut.",
    "Mazmur 27:1 — TUHAN adalah terang dan keselamatanku; siapa yang harus kutakuti?",
    "Mazmur 121:1-2 — Pertolonganku dari TUHAN, yang menjadikan langit dan bumi.",
    "2 Timotius 1:7 — Allah memberikan roh yang membangkitkan kekuatan dan kasih, bukan roh ketakutan.",
    "Amsal 12:25 — Kekuatiran menekan hati, tetapi perkataan yang baik menyukakannya.",
    "Roma 8:31 — Jika Allah di pihak kita, siapa yang melawan kita?"
  ],
  takut: [
    "Yesaya 41:10 — Jangan takut, sebab Aku menyertai engkau.",
    "Mazmur 27:1 — TUHAN adalah terangku dan keselamatanku; kepada siapa aku harus takut?",
    "Mazmur 56:4 — Pada waktu aku takut, aku percaya kepada-Mu.",
    "Mazmur 34:4 — Aku mencari TUHAN, lalu Ia menjawab aku dan melepaskan aku dari semua ketakutanku.",
    "2 Timotius 1:7 — Allah memberikan roh yang membangkitkan kekuatan, kasih dan ketertiban.",
    "Ulangan 31:6 — Kuatkan dan teguhkanlah hatimu; jangan takut dan jangan tawar hati.",
    "Mazmur 23:4 — Sekalipun aku berjalan dalam lembah kekelaman, aku tidak takut bahaya.",
    "Yosua 1:9 — Kuatkan dan teguhkanlah hatimu; jangan takut!",
    "Mazmur 118:6 — TUHAN di pihakku; aku tidak takut.",
    "Yesaya 43:1 — Jangan takut, sebab Aku telah menebus engkau.",
    "Mazmur 91:1-2 — Tempat perlindungan dan keselamatan ada pada Tuhan.",
    "Lukas 12:32 — Jangan takut, hai kawanan kecil!",
    "Mazmur 3:6 — Aku tidak takut kepada puluhan ribu orang yang mengepung aku.",
    "Mazmur 46:2 — Allah itu tempat perlindungan dan kekuatan; sebab itu kita tidak takut.",
    "Mazmur 56:11 — Kepada Allah aku percaya, aku tidak takut.",
    "Mazmur 4:9 — Dengan tenteram aku mau membaringkan diri dan tidur.",
    "Yesaya 12:2 — Sesungguhnya Allah itu keselamatanku; aku percaya dan tidak takut.",
    "Mazmur 91:11 — Malaikat-malaikat-Nya memelihara engkau.",
    "Amsal 3:25-26 — Jangan takut terhadap kehancuran tiba-tiba, sebab TUHAN menjadi tempat perlindungan.",
    "Filipi 4:13 — Segala perkara dapat kutanggung dalam Dia yang memberi kekuatan kepadaku."
  ]
};
</script>

<script>
// -----------------------------
// APP LOGIC
// -----------------------------
const LS_EMOTION = 'seayat_emotion';
const LS_STREAK = 'seayat_streak';
const LS_LASTCHECK = 'seayat_lastcheck';
const LS_HISTORY = 'seayat_history';
const LS_NOTES = 'seayat_notes';
const LS_REMINDER = 'seayat_reminder';
const LS_USAGE = 'seayat_usage_start';

let currentEmotion = localStorage.getItem(LS_EMOTION) || null;
let streak = parseInt(localStorage.getItem(LS_STREAK) || '0', 10) || 0;
let lastCheck = localStorage.getItem(LS_LASTCHECK) || null;
let history = JSON.parse(localStorage.getItem(LS_HISTORY) || '[]');
let notes = JSON.parse(localStorage.getItem(LS_NOTES) || '{}');
let reminder = JSON.parse(localStorage.getItem(LS_REMINDER) || JSON.stringify({time:'07:00', lastNotified: null}));

const tiles = document.querySelectorAll('.emotion-tile');
const verseEl = document.getElementById('verse');
const titleEl = document.getElementById('emotionTitle');
const streakEl = document.getElementById('streakCount');
const checkInBtn = document.getElementById('checkInBtn');
const shareBtn = document.getElementById('shareBtn');
const historyBtn = document.getElementById('historyBtn');
const notesBtn = document.getElementById('notesBtn');
const statsBtn = document.getElementById('statsBtn');
const dailyTimeInput = document.getElementById('dailyTime');
const setDailyBtn = document.getElementById('setDailyBtn');
const notifStatus = document.getElementById('notifStatus');
const usageStatus = document.getElementById('usageStatus');
const noteArea = document.getElementById('note');
const saveNoteBtn = document.getElementById('saveNote');

const historyCard = document.getElementById('historyCard');
const historyList = document.getElementById('historyList');
const notesCard = document.getElementById('notesCard');
const statsCard = document.getElementById('statsCard');
const chartCanvas = document.getElementById('chartCanvas');

function capitalize(s){ return s ? s.charAt(0).toUpperCase() + s.slice(1) : s; }

function notify(title, body){
  if('Notification' in window && Notification.permission === 'granted'){
    if(navigator.serviceWorker && navigator.serviceWorker.ready){
      navigator.serviceWorker.ready.then(reg => reg.showNotification(title, {body, tag:'seayat-notif', renotify:true}));
    } else {
      new Notification(title, {body});
    }
  } else {
    alert(title + "\n\n" + body);
  }
}

async function requestNotificationPermission(){
  if(!('Notification' in window)) return false;
  if(Notification.permission === 'granted') return true;
  const perm = await Notification.requestPermission();
  updateNotifUI();
  return perm === 'granted';
}

function updateNotifUI(){
  if(!('Notification' in window)){ notifStatus.textContent = 'Notifikasi tidak didukung'; return; }
  if(Notification.permission === 'granted') notifStatus.textContent = 'Izin notifikasi: diberikan';
  else if(Notification.permission === 'denied') notifStatus.textContent = 'Izin notifikasi: ditolak';
  else notifStatus.textContent = 'Izin notifikasi: belum diminta';
}

// Usage timer
let usageStart = parseInt(localStorage.getItem(LS_USAGE) || '0', 10) || 0;
if(!usageStart){
  usageStart = Date.now();
  localStorage.setItem(LS_USAGE, String(usageStart));
}
function checkUsageElapsed(){
  const elapsed = Date.now() - usageStart;
  const minutes = Math.floor(elapsed / 60000);
  usageStatus.textContent = 'Sudah membuka: ' + minutes + ' menit';
  if(minutes >= 60 && !localStorage.getItem('seayat_usage_warned')){
    notify('Seayat Sehari — Waktunya istirahat', 'Kamu sudah membuka aplikasi selama 1 jam. Istirahatlah sejenak.');
    localStorage.setItem('seayat_usage_warned','1');
  }
}
setInterval(checkUsageElapsed, 60*1000);
checkUsageElapsed();

function scheduleDailyCheck(){
  setInterval(()=> {
    const now = new Date();
    const hh = String(now.getHours()).padStart(2,'0');
    const mm = String(now.getMinutes()).padStart(2,'0');
    const hm = hh + ':' + mm;
    const today = now.toISOString().slice(0,10);
    if(reminder && reminder.time === hm && reminder.lastNotified !== today){
      notify('Seayat Sehari — Waktu Renungan', 'Saatnya membaca ayat & check-in hari ini');
      reminder.lastNotified = today;
      localStorage.setItem(LS_REMINDER, JSON.stringify(reminder));
    }
  }, 60*1000);
}

function recordHistory(emotion, verse){
  const date = new Date().toISOString().slice(0,10);
  const time = new Date().toLocaleTimeString();
  history.push({date, time, emotion, verse});
  if(history.length > 1000) history = history.slice(-1000);
  localStorage.setItem(LS_HISTORY, JSON.stringify(history));
}

function incrementEmotionCount(em){
  const counts = JSON.parse(localStorage.getItem('seayat_counts') || '{}');
  counts[em] = (counts[em] || 0) + 1;
  localStorage.setItem('seayat_counts', JSON.stringify(counts));
}
function getCounts(){ return JSON.parse(localStorage.getItem('seayat_counts') || '{}'); }

let chartObj = null;
function renderChart(){
  if(!chartCanvas) return;
  const counts = getCounts();
  const labels = Object.keys(ALL_VERSES).map(k => capitalize(k));
  const data = Object.keys(ALL_VERSES).map(k => counts[k] || 0);
  const ctx = chartCanvas.getContext('2d');
  if(chartObj) chartObj.destroy();
  chartObj = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Frekuensi',
        data,
        backgroundColor: ['#4CAF50','#2196F3','#F44336','#9C27B0','#FFC107','#795548']
      }]
    },
    options: { responsive:true, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true } } }
  });
}

function refreshUI(){
  tiles.forEach(t => t.classList.toggle('selected', t.dataset.emotion === currentEmotion));
  streakEl.textContent = String(streak || 0);
  dailyTimeInput.value = reminder.time || '07:00';
  updateNotifUI();
}

function showVerseFor(emotion){
  const list = ALL_VERSES[emotion] || [];
  if(!list.length){ verseEl.textContent = 'Ayat belum tersedia.'; return; }
  const idx = Math.floor(Math.random()*list.length);
  const verse = list[idx];
  verseEl.textContent = verse;
  titleEl.textContent = 'Perasaanmu hari ini: ' + capitalize(emotion);
  recordHistory(emotion, verse);
}

function autoCheckInIfNeeded(){
  const today = new Date().toDateString();
  if(localStorage.getItem(LS_LASTCHECK) !== today){
    streak = (parseInt(localStorage.getItem(LS_STREAK) || '0', 10) || 0) + 1;
    localStorage.setItem(LS_STREAK, String(streak));
    localStorage.setItem(LS_LASTCHECK, today);
    streakEl.textContent = String(streak);
    alert('Check-in otomatis tersimpan. Selamat! 🔥');
  }
}

tiles.forEach(tile => {
  tile.addEventListener('click', async () => {
    const key = tile.dataset.emotion;
    if(currentEmotion && currentEmotion !== key){
      const ok = confirm('Kamu sudah memilih "'+ capitalize(currentEmotion) + '". Ganti menjadi "'+ capitalize(key) +'"?');
      if(!ok) return;
    } else if(!currentEmotion){
      const ok2 = confirm('Apakah kamu merasa "'+ capitalize(key) +'" hari ini?');
      if(!ok2) return;
    }
    currentEmotion = key;
    localStorage.setItem(LS_EMOTION, currentEmotion);
    showVerseFor(currentEmotion);
    incrementEmotionCount(currentEmotion);
    autoCheckInIfNeeded();
    refreshUI();
    renderChart();
  });
});

if(checkInBtn){
  checkInBtn.addEventListener('click', ()=> {
    const today = new Date().toDateString();
    if(localStorage.getItem(LS_LASTCHECK) === today){
      alert('Kamu sudah check-in hari ini!');
      return;
    }
    streak = (parseInt(localStorage.getItem(LS_STREAK) || '0', 10) || 0) + 1;
    localStorage.setItem(LS_STREAK, String(streak));
    localStorage.setItem(LS_LASTCHECK, today);
    streakEl.textContent = String(streak);
    alert('Check-in berhasil! Tetap semangat 🙏');
  });
}

if(shareBtn){
  shareBtn.addEventListener('click', ()=> {
    const text = verseEl.textContent;
    if(!text || text.startsWith('Ayat')){ alert('Belum ada ayat untuk dibagikan.'); return; }
    const payload = 'Seayat Sehari — Ayat hari ini:\n\n' + text + '\n\n(#SeayatSehari)';
    if(navigator.share){
      navigator.share({title:'Seayat Sehari', text:payload}).catch(()=>{});
    } else {
      const wa = 'https://wa.me/?text=' + encodeURIComponent(payload);
      window.open(wa,'_blank');
    }
  });
}

if(saveNoteBtn){
  saveNoteBtn.addEventListener('click', ()=> {
    const txt = noteArea.value.trim();
    const date = new Date().toISOString().slice(0,10);
    if(!txt){ alert('Tulis catatan terlebih dahulu.'); return; }
    notes[date] = txt;
    localStorage.setItem(LS_NOTES, JSON.stringify(notes));
    alert('Catatan disimpan.');
  });
}
document.getElementById('viewNote') && document.getElementById('viewNote').addEventListener('click', ()=> {
  const date = new Date().toISOString().slice(0,10);
  const txt = notes[date] || '';
  if(!txt) alert('Belum ada catatan untuk hari ini.');
  else alert('Catatan ' + date + ':\n\n' + txt);
});

if(historyBtn){
  historyBtn.addEventListener('click', ()=> {
    historyCard.style.display = historyCard.style.display === 'none' ? 'block' : 'none';
    if(historyCard.style.display === 'block') renderHistory();
  });
}

function renderHistory(){
  if(!history || history.length === 0){ historyList.innerHTML = '<div style="padding:8px">Belum ada riwayat.</div>'; return; }
  const recent = history.slice().reverse().slice(0,100);
  historyList.innerHTML = '';
  recent.forEach(h => {
    const d = document.createElement('div');
    d.style.padding='8px'; d.style.borderBottom='1px solid #eef7ee';
    d.innerHTML = '<strong>' + h.date + ' ' + h.time + '</strong><div style="margin-top:6px">' + capitalize(h.emotion) + ' — ' + h.verse + '</div>';
    historyList.appendChild(d);
  });
}

if(statsBtn){
  statsBtn.addEventListener('click', ()=> {
    statsCard.style.display = statsCard.style.display === 'none' ? 'block' : 'none';
    if(statsCard.style.display === 'block') renderChart();
  });
}

if(setDailyBtn){
  setDailyBtn.addEventListener('click', async ()=>{
    const t = dailyTimeInput.value || '07:00';
    reminder.time = t;
    localStorage.setItem(LS_REMINDER, JSON.stringify(reminder));
    const ok = await requestNotificationPermission();
    if(ok) alert('Reminder harian di-set pada ' + t + '. Izin notifikasi diberikan.');
    else alert('Reminder disimpan, tapi izin notifikasi belum diberikan.');
  });
}

if(notifStatus){
  notifStatus.addEventListener && notifStatus.addEventListener('click', async ()=> {
    const ok = await requestNotificationPermission();
    if(ok) alert('Izin notifikasi diberikan.');
  });
}

if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').then(()=> console.log('sw registered')).catch(()=> console.warn('sw registration failed'));
}

(function init(){
  const today = new Date().toISOString().slice(0,10);
  const lastWarnDay = localStorage.getItem('seayat_usage_warn_day');
  if(lastWarnDay !== today){
    localStorage.removeItem('seayat_usage_warned');
    localStorage.setItem('seayat_usage_warn_day', today);
  }
  currentEmotion = localStorage.getItem(LS_EMOTION) || currentEmotion;
  streak = parseInt(localStorage.getItem(LS_STREAK) || String(streak),10) || streak;
  streakEl.textContent = String(streak || 0);
  if(currentEmotion) showVerseFor(currentEmotion);
  refreshUI();
  renderChart();
  scheduleDailyCheck();
})();
</script>
</body>
</html>
